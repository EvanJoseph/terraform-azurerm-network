parameters:
- name: environment
  type: string
- name: dependsOn
  type: string

jobs:
  - job: ${{ parameters.environment}}infracost
    pool:
      vmImage: ubuntu-latest
    dependsOn: ${{parameters.dependsOn}}
    displayName: "${{ parameters.environment }} Infracost Analysis"
    steps:
      - task: DownloadBuildArtifacts@1
        displayName: "Download > terraform_plan.json Artifact"
        inputs:
          buildType: 'current'
          artifactName: '${{ parameters.environment }}plan'
          downloadType: 'single'
          downloadPath: '$(System.DefaultWorkingDirectory)'
      - bash: |
          docker run -e INFRACOST_API_KEY=$(INFRACOST_API_KEY) \
          -v $(pwd):/tf infracost/infracost breakdown \
          --path /tf/terraform_plan.json --show-skipped

          docker run -e INFRACOST_API_KEY=$(INFRACOST_API_KEY) \
          -v $(pwd):/tf infracost/infracost breakdown \
          --path /tf/terraform_plan.json --show-skipped --format json \
          --out-file infracost.json          
        workingDirectory: $(System.DefaultWorkingDirectory)/${{ parameters.environment }}plan
        displayName: "Run > infracost"
        env:
          INFRACOST_API_KEY: $(INFRACOST_API_KEY)